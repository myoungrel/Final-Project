<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Magazine Generator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f2f6;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        /* --- [1. ì¹´ë“œ ë° ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€] --- */
        .article-card {
            background: #fff;
            border: 1px solid #ddd;
            border-left: 5px solid #ff4b4b;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .article-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .article-number {
            font-weight: bold;
            color: #ff4b4b;
            font-size: 1.1em;
        }

        .remove-btn {
            background: #666;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-btn:hover {
            background: #444;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }

        /* --- [2. ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ ì¶”ê°€] --- */
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-add {
            background-color: #4CAF50;
            color: white;
        }

        /* ì´ˆë¡ìƒ‰ */
        .btn-add:hover {
            background-color: #45a049;
        }

        .btn-generate {
            background-color: #ff4b4b;
            color: white;
        }

        /* ë¹¨ê°„ìƒ‰ */
        .btn-generate:hover {
            background-color: #d43f3f;
        }

        #result-area {
            margin-top: 30px;
            border: 1px solid #ddd;
            padding: 10px;
            background: white;
            min-height: 400px;
        }

        iframe {
            width: 100%;
            height: 800px;
            border: none;
        }

        /* --- [í† ê¸€ ìŠ¤ìœ„ì¹˜ ìŠ¤íƒ€ì¼] --- */
        .switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
        }

        .switch-label {
            font-weight: bold;
            color: #333;
            font-size: 0.9em;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #ff4b4b;
        }

        input:checked+.slider:before {
            transform: translateX(18px);
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ“š AI Magazine Maker</h1>

        <div id="articles-container"></div>

        <div class="btn-group">
            <button class="btn-add" onclick="addPage()">+ í˜ì´ì§€ ì¶”ê°€ (Add Page)</button>
            <button class="btn-generate" onclick="generateMagazine()">ë§¤ê±°ì§„ ìƒì„± ì‹œì‘! ğŸš€</button>
        </div>

        <div id="loading" style="display:none; text-align:center; margin-top:20px; color: #ff4b4b; font-weight: bold;">
            â³ AI ì—ì´ì „íŠ¸ íŒ€ì´ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤... <br> (í˜ì´ì§€ê°€ ë§ìœ¼ë©´ ì‹œê°„ì´ ë” ê±¸ë¦½ë‹ˆë‹¤)
        </div>
    </div>

    <div id="result-area" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>âœ¨ ìƒì„± ê²°ê³¼</h3>
            <a id="download-btn"
                style="display:none; background:#4CAF50; color:white; padding:10px 15px; text-decoration:none; border-radius:5px; font-weight:bold; cursor:pointer;">ğŸ’¾
                HTML ë‹¤ìš´ë¡œë“œ</a>
        </div>
        <div id="output-frame"></div>
    </div>

    <script>
        let pageCount = 0;

        // [5. í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ 1ê°œ ì¶”ê°€]
        window.onload = function () {
            addPage();
        };

        // [6. í˜ì´ì§€(ì¹´ë“œ) ì¶”ê°€ í•¨ìˆ˜ êµ¬í˜„]
        function addPage() {
            pageCount++;
            const container = document.getElementById('articles-container');

            const card = document.createElement('div');
            card.className = 'article-card';
            card.id = `card-${pageCount}`;

            // ê¸°ì¡´ HTML í¼ì„ í…œí”Œë¦¿ ë¬¸ìì—´ë¡œ ë„£ìŒ (IDëŒ€ì‹  class ì‚¬ìš© ì¤‘ìš”!)
            card.innerHTML = `
                <div class="article-header">
                    <span class="article-number">Page #${pageCount}</span>
                    ${pageCount > 1 ? `<button class="remove-btn" onclick="removePage('card-${pageCount}')">ì‚­ì œ âŒ</button>` : ''}
                </div>

                <div class="form-group">
                    <label>ì œëª© (Headline)</label>
                    <input type="text" class="input-title" placeholder="ì˜ˆ: Summer Vibes" value="Summer Vibes">
                </div>

                <div class="form-group">
                    <label>ìŠ¤íƒ€ì¼ (Style)</label>
                    <select class="input-style">
                        <option value="Modern">Modern</option>
                        <option value="Elegant">Elegant</option>
                        <option value="Retro">Retro</option>
                        <option value="Bold">Bold</option>
                    </select>
                </div>

                <div class="switch-container">
                    <span class="switch-label">ğŸ¤– AIê°€ ê¸€ ë‹¤ì‹œ ì“°ê¸° (AI Rewrite)</span>
                    <label class="switch">
                        <input type="checkbox" class="input-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="form-group">
                    <label>ë³¸ë¬¸ (Body Text)</label>
                    <textarea class="input-body" rows="3" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.">ì´ ì‚¬ì§„ì€ ì¦ê±°ìš´ ì—¬ë¦„ íœ´ê°€ì˜ ì¶”ì–µì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.</textarea>
                </div>

                <div class="form-group">
                    <label>ì‚¬ì§„ ì—…ë¡œë“œ</label>
                    <input type="file" class="input-file" accept="image/*">
                </div>
            `;
            container.appendChild(card);
        }

        // [7. í˜ì´ì§€ ì‚­ì œ í•¨ìˆ˜]
        function removePage(cardId) {
            const card = document.getElementById(cardId);
            if (card) card.remove();
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // [8. ìƒì„± í•¨ìˆ˜ ì „ì²´ ìˆ˜ì • (ë‹¤ì¤‘ ì²˜ë¦¬ ë¡œì§)]
        async function generateMagazine() {
            // ëª¨ë“  ì¹´ë“œë¥¼ ì°¾ìŒ
            const cards = document.querySelectorAll('.article-card');
            let hasError = false;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('result-area').style.display = 'none';

            // ê° ì¹´ë“œë¥¼ ëŒë©´ì„œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘
            const promises = Array.from(cards).map(async (card, index) => {
                // IDê°€ ì•„ë‹Œ classë¡œ ë‚´ë¶€ ìš”ì†Œ ì°¾ê¸°
                const title = card.querySelector('.input-title').value;
                const style = card.querySelector('.input-style').value;
                const body = card.querySelector('.input-body').value;
                const isGenerated = card.querySelector('.input-toggle').checked;
                const fileInput = card.querySelector('.input-file');

                if (fileInput.files.length === 0) {
                    alert(`Page #${index + 1}ì˜ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!`);
                    hasError = true;
                    return null;
                }

                const base64Img = await toBase64(fileInput.files[0]);

                return {
                    id: String(index),
                    title: title || "Untitled",
                    request: body,  // ì„œë²„ì˜ user_request ë§¤í•‘ìš©
                    style: style,
                    is_generated: isGenerated,
                    image_base64: base64Img
                };
            });

            const results = await Promise.all(promises);

            if (hasError) {
                document.getElementById('loading').style.display = 'none';
                return;
            }

            const validArticles = results.filter(item => item !== null);

            try {
                // ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ ì„œë²„ ì „ì†¡
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ articles: validArticles })
                });

                if (!response.ok) throw new Error("Server Error");

                const htmlContent = await response.text();
                const frameContainer = document.getElementById('output-frame');
                frameContainer.innerHTML = `<iframe srcdoc='${htmlContent.replace(/'/g, "&apos;")}' sandbox="allow-scripts allow-same-origin"></iframe>`;

                // [New] ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í™œì„±í™” ë¡œì§
                const downloadBtn = document.getElementById('download-btn');
                const blob = new Blob([htmlContent], { type: 'text/html' });
                downloadBtn.href = URL.createObjectURL(blob);
                downloadBtn.download = `magazine_${new Date().getTime()}.html`;
                downloadBtn.style.display = 'inline-block';

                document.getElementById('result-area').style.display = 'block';

            } catch (error) {
                alert("ì—ëŸ¬ ë°œìƒ: " + error.message);
                console.error(error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
    </script>
</body>

</html>